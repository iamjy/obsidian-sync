---
title: Gstreamer를 이용한 30fps 녹화 시 30fps 미만의 UVC 입력으로 인한 무작위 아티팩트 문제 발생
source:
author:
  - "[[@_louis]]"
published:
created: 2025-09-15
description: FPGA 기반 카메라 보드 ( Cypress FX3 사용, PCLK 40MHz, 30fps 미만 출력 ) 가 V4L2에서 30fps로 인식도며, Gstreamer로 30fps 녹화 시  UVC 타임스탬프 비활성화로 인해 무작위 시점에서 1 ~ 2초 아티팩트 ( 줄무늬, 화면 어긋남 ) 가 발생. RAW 데이터 ( YUV ) 덤프는 정이며, 문제는 동기화 불일치와 인코딩 과정에서 기인.
tags:
  - gstreamer-recording-issues-artifact
---

# GStreamer UVC 녹화 아티팩트 문제 분석 및 해결책

## 개요
RPi CM4 SoM과 custom 카메라 보드(Cypress FX3 + FPGA)를 사용해 GStreamer로 1080p 30fps 녹화 시, 무작위 시점(1~2초)에 judder(어색한 움직임)나 줄무늬 아티팩트 발생. Raw YUV 덤프는 정상, 레퍼런스 I/O 보드에서는 문제 없음. 주요 원인은 FPGA PCLK 40MHz(~17fps)와 UVC 30fps 설정 간 불일치, 타임스탬프 비활성화로 추정.

**상황 요약**:
- **재현 빈도**: 무작위 시점(1~2초)
- **UVC 타임스탬프**: 비활성화
- **FPGA PCLK**: 40MHz (30fps 미만, 1080p YUY2 기준 72MHz 필요)
- **증상**: x264enc 인코딩 시 아티팩트, raw YUV 정상
- **환경**: CM4 SoM, custom 카메라 보드, USB 3.0, GStreamer

## 의심되는 원인
아티팩트의 원인을 우선순위별로 정리. 무작위 재현은 동적 요인(버퍼링, USB/interrupt 지터) 때문.

| 우선순위 | 원인                     | 설명                                                           | 관련 증상                                        |
| ---- | ---------------------- | ------------------------------------------------------------ | -------------------------------------------- |
| 높음   | FPS 불일치 (FPGA PCLK 제한) | FPGA PCLK 40MHz로 30fps 미만 출력, FX3 UVC descriptor 30fps와 불일치. | 프레임 드롭/중복, 무작위 judder/artifacts, raw YUV 정상. |
| 높음   | UVC 타임스탬프 비활성화         | 타임스탬프 없어 GStreamer가 시스템 클럭으로 추정, PCLK 지터로 타이밍 불일치.           | 버퍼 고갈 시 1~2초 아티팩트, 무작위 재현.                   |
| 중간   | FX3 DMA/USB 지터         | Custom board USB 3.0 trace/전원 불안정, DMA 버퍼 부족으로 프레임 불규칙.      | Interrupt 과부하, 중간 아티팩트, 레퍼런스 보드와 차이.         |
| 중간   | GStreamer 버퍼/싱크        | videorate 중복이나 x264enc VBV 오버플로, 타임스탬프 없어 PTS 불안정.           | 인코딩 단계 문제, raw 정상, 무작위 언더플로.                 |
| 낮음   | Interrupt/CPU 부하       | CM4 USB 호스트(VL805) interrupt 폭증, x264enc 지연.                 | 지속 스트리밍 중 누적, custom board 전원 노이즈 악화.        |

## 해결책
근본 해결(FPS 불일치, 타임스탬프)부터 증상 완화(GStreamer 최적화)까지 단계별로 제시.
예상 효과: 아티팩트 80~90% 감소.

### 1. FPS 불일치 (FPGA PCLK 제한) 해결
FPGA PCLK를 30fps(72MHz)로 복구하거나, 시스템 전체를 실제 FPS(17fps)에 맞춤. 주요 병목 해결.

#### 단계별 작업
- [ ] FPGA PCLK 72MHz로 조정 (최우선).
- [ ] 불가능 시 FX3 descriptor를 17fps로 수정.
- [ ] GStreamer 파이프라인 framerate=17/1로 동기화.

```verilog
// FPGA PLL 설정 (72MHz PCLK, Verilog, Lattice CrossLink NX 예시)
module pll_clk_gen (
    input  sys_clk_100mhz,
    output pclk_72mhz
);
    SB_PLL40_CORE #(
        .FEEDBACK_PATH("SIMPLE"),
        .PLLOUT_SELECT("GENCLK"),
        .DIVR(4'b0000),  // 입력 분주
        .DIVF(7'b0110001),  // 피드백 분주 (72MHz)
        .DIVQ(3'b100),  // 출력 분주
        .FILTER_RANGE(3'b001)
    ) pll_inst (
        .REFERENCECLK(sys_clk_100mhz),
        .PLLOUTCORE(pclk_72mhz),
        .RESETB(1'b1),
        .BYPASS(1'b0)
    );
endmodule
```

```c
// FX3 descriptor 수정 (uvc.c, 17fps, ~58ms = 58823529ns)
uint8_t videoFrameDesc[] = {
    0x1E, 0x04, 0x01, 0x01,   // Frame descriptor
    0x00, 0x80, 0x07, 0x38,   // 1920x1080
    0x00, 0x65, 0x04, 0x00,   // Bitrate (조정 필요)
    0x15, 0x16, 0x05, 0x00,   // Max frame size (YUY2)
    0x19, 0x35, 0x3C, 0x03,   // dwFrameInterval=58823529 (17fps)
    0x01, 0x00
};
CyU3PUvcAppDescriptorSet(CY_U3P_UVC_STREAMING_CONTROL, videoFrameDesc);

// 빌드 및 플래시
// cyusb_programmer -i firmware.img
```

```bash
# GStreamer 파이프라인 (17fps 맞춤)
gst-launch-1.0 v4l2src device=/dev/video0 io-mode=mmap do-timestamp=true ! \
video/x-raw,width=1920,height=1080,framerate=17/1,format=YUY2 ! \
videorate drop-only=true ! videoconvert ! x264enc speed-preset=ultrafast bitrate=5000 tune=zerolatency ! \
h264parse ! mp4mux ! filesink location=output.mp4
```

### 2. UVC 타임스탬프 비활성화 해결
타임스탬프 활성화로 GStreamer의 프레임 타이밍 동기화 개선. 무작위 아티팩트 완화.

#### 단계별 작업
- [ ] FX3 펌웨어에 타임스탬프 추가.
- [ ] v4l2-ctl로 타임스탬프 지원 확인.
- [ ] GStreamer에 do-timestamp=true 적용.

```c
// FX3 펌웨어 타임스탬프 활성화 (uvc.c)
CyU3PUvcAppDescriptorSet(CY_U3P_UVC_STREAMING_CONTROL, CY_U3P_UVC_HEADER_TIMESTAMP, 1);

// DMA 콜백에서 타임스탬프 삽입
CyU3PUvcAddHeader(pUvcHeader, CY_U3P_UVC_HEADER_FRAME | CY_U3P_UVC_HEADER_TIMESTAMP);
CyU3PUvcSetTimestamp(pUvcHeader, CyU3PGetTime());  // 100ns 단위

// 빌드 및 플래시
// cyusb_programmer -i firmware.img
```

```bash
# 타임스탬프 지원 확인
v4l2-ctl -d /dev/video0 --get-ctrl=timestamp  # 1 출력 시 활성화

# GStreamer 파이프라인 (타임스탬프 적용)
GST_DEBUG=5,v4l2*:6 gst-launch-1.0 v4l2src device=/dev/video0 io-mode=mmap do-timestamp=true ! \
video/x-raw,width=1920,height=1080,framerate=30/1,format=YUY2 ! videorate drop-only=true ! \
videoconvert ! x264enc speed-preset=ultrafast bitrate=5000 tune=zerolatency ! h264parse ! \
mp4mux ! filesink location=output.mp4
```

### 3. FX3 DMA/USB 지터 해결
DMA 버퍼 크기 증가와 USB 안정화로 프레임 불규칙 전송 완화.

#### 단계별 작업
- [ ] FX3 DMA 버퍼 32KB로 증가.
- [ ] Custom board USB trace/전원 점검.
- [ ] USB autosuspend 비활성화.

```c
// FX3 DMA 버퍼 증가 (cyu3dma.h 기반, uvc.c)
CyU3PDmaChannelSetBufferSize(&glChHandle_UVC_DMA, 32 * 1024, 0);  // 32KB
CyU3PDmaChannelSetWrapUp(&glChHandle_UVC_DMA, CyTrue);  // Wrap-up 활성화

// 빌드 및 플래시
// cyusb_programmer -i firmware.img
```

```bash
# USB autosuspend 비활성화
echo -1 > /sys/module/usbcore/parameters/autosuspend

# USB 연결 확인
lsusb -t  # SuperSpeed(5Gbps) 확인

# Interrupt 부하 모니터링
watch -n 1 "cat /proc/interrupts | grep usb"
```

### 4. GStreamer 버퍼/싱크 처리 해결
버퍼 강화와 싱크 비활성화로 무작위 아티팩트 완화.

#### 단계별 작업
- [ ] Queue 요소 추가, leaky 설정.
- [ ] x264enc VBV 버퍼 증가.
- [ ] ffprobe로 PTS 분석.

```bash
# GStreamer 파이프라인 (버퍼 강화)
gst-launch-1.0 v4l2src device=/dev/video0 io-mode=mmap do-timestamp=true ! \
video/x-raw,width=1920,height=1080,framerate=30/1,format=YUY2 ! \
queue max-size-buffers=10 leaky=downstream ! videorate drop-only=true max-duplication-time=0 ! \
videoconvert ! x264enc speed-preset=ultrafast bitrate=5000 tune=zerolatency vbv-bufsize=2000 sync=false ! \
h264parse ! mp4mux ! filesink location=output.mp4

# 로그 및 PTS 분석
GST_DEBUG=5,v4l2*:6,x264*:5 gst-launch-1.0 ...  # 위 명령어에 추가
ffprobe -show_frames output.mp4 | grep pts_time  # 무작위 간격 확인
```

### 5. Interrupt/CPU 부하 해결
Interrupt 부하 분산으로 CPU 인코딩 지연 감소.

#### 단계별 작업
- [ ] Interrupt 모니터링.
- [ ] Affinity 설정 또는 irqbalance 활성화.

```bash
# USB IRQ 번호 확인
dmesg | grep usb  # 예: IRQ 82 = fe980000.usb

# Affinity 설정 (코어 1)
echo 2 > /proc/irq/82/smp_affinity  # 16진수: 코어 1 (0x2)

# irqbalance 활성화
sudo apt install irqbalance && sudo systemctl enable --now irqbalance

# 모니터링
watch -n 1 "cat /proc/interrupts | grep usb"
```

## 테스트 및 디버깅
- **테스트 전략**:
  - 10초 녹화 10회 반복, 아티팩트 위치 확인.
  - PCLK 40MHz 고정 시 framerate=17/1로 테스트.
  - ffprobe로 PTS 불일치 분석.
- **디버깅 도구**:
  - `v4l2-ctl --list-formats-ext` 전체 출력 확인.
  - Cypress Control Center/Wireshark로 USB 패킷 캡처 (SCR 타임스탬프 확인).
  - FPGA 로그로 PCLK 안정성 확인 (오실로스코프 권장).

## 추가 참고
- **RPi OS 업데이트**: `sudo rpi-update`로 USB 드라이버 최신화.
- **참고 문서**: Cypress AN75779, Lattice CrossLink NX 매뉴얼, GStreamer 문서.
- **필요 정보**: FX3 펌웨어 코드, FPGA PCLK 설정, GStreamer 로그 공유 시 더 세밀한 분석 가능.

---

#GStreamer #UVC #FPGA #아티팩트 #CM4 #FX3
